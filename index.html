<html>
<head>
	<title>mdoc</title>

	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>

	<script type="text/javascript" src="mdoc.js"></script>
	<script type="text/javascript" src="semantic-ui/semantic.min.js"></script>

	<link rel="stylesheet" href="semantic-ui/semantic.min.css">
	<link rel="stylesheet" href="style.css">

	<script type="text/javascript">
		$(document).ready(function() {
			var mdoc = {};

			$.getJSON("index.json", function(data) {
				$(".main.menu .header").text(data.title);

				mdoc = new MDoc(data).load(function(m) {
					$("#doc").empty();
					$("#toc").empty();

					$.each(m.index.contents, function(i, grp) {
						$("#toc").append($("<div/>").addClass("header item").text(grp.group));

						$.each(grp.contents, function(d, doc) {
							var index = i.toString() + "_" + d.toString();
							var pageRenderer = pageRenderer(index, doc.depth);

							var docDiv = $("<div/>").addClass("ui basic segment")
											//.append($("<h1/>").addClass("ui dividing header").text(doc.title))
											.append(marked(doc.document, { renderer: pageRenderer }))
											.append($("<div/>").addClass("ui hidden divider"));

							$("#doc").append(docDiv);

							var tocHead = $("<div/>").addClass("item");
							var tocMenu = $("<div/>").addClass("menu");
							tocHead.append(tocMenu);
							$("#toc").append(tocHead);

							$.each(doc.toc, function(t, toc) {
								tocMenu.append($("<a/>").addClass("item toc-" + toc.depth + "-deep")
									.attr("href", "#" + index + "_" + toc.slug)
									.text(toc.title));
							});
						});
					});

					$(".ui.sticky").sticky({
						context: "#doc"
					});
				});
			});
		});

		/**
		 * Create a marked renderer with custom header renderer, used
		 * to ensure that we generate unique section ids for linking.
		 * Also, heading levels below dividingLevel will be set as 
		 * dividers.
		 */
		pageRenderer = function(index, dividingLevel) {
			var renderer = new marked.Renderer();
			renderer._index = index;

			renderer.heading = function (text, level) {
				var slug = text.toLowerCase().replace(/[^\w]+/g, '-');
				var cssClass = level <= dividingLevel ? "class='ui dividing header'" : "";
				return "<h" + level + " id='" + this._index + "_" + slug + "' " + cssClass + ">" + text + "</h" + level + ">";
			}
			return renderer;
		}

	</script>
</head>
<body>
	<div class="ui inverted main menu">
		<div class="container">
			<h2 class="ui inverted header">mdoc</h2>
		</div>
	</div>
	<div class="main container">
		<div class="ui right very close rail">
			<div id="toc" class="ui sticky vertical menu"></div>
		</div>
		<div id="doc">
			<div class="ui active inverted dimmer">
    			<div class="ui large text loader">Loading</div>
  			</div>
  		</div>
	</div>
</body>
</html>